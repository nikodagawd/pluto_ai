<div class="min-h-screen bg-[#fdf5e6] flex flex-col items-center py-10 px-4">
  <div class="max-w-4xl w-full">

    <div class="text-center mb-12">
      <p class="text-xl md:text-2xl text-black font-semibold flex items-center justify-center gap-2">
        üîç AI-Powered Discovery
      </p>
      <h1 class="text-5xl md:text-6xl font-bold text-black mt-4">
        Company Explorer
      </h1>

      <p class="mt-6 text-gray-600 text-lg md:text-xl max-w-3xl mx-auto leading-tight">
        <span class="block mb-2 text-black font-medium">
          Ask our AI to find innovative companies.
        </span>
        <span class="text-gray-500 text-base md:text-lg">
          Use natural language to search by <span class="text-indigo-600">sector</span>, <span class="text-indigo-600">location</span>, <span class="text-indigo-600">funding stage</span>, and more.
        </span>
      </p>
    </div>

    <div class="w-full bg-white rounded-xl shadow-lg p-8 flex flex-col">
      <p class="text-gray-500 mb-4 text-lg">What would you like to know?</p>

      <%= form_with url: chat_path, method: :post, local: true, data: { turbo: false }, class: "w-full mb-6" do |f| %>
        <div class="relative border border-gray-300 rounded-xl focus-within:ring-2 focus-within:ring-indigo-500 bg-gray-50">
          <%= f.text_area :message, value: @message, placeholder: "Type your question here...",
              class: "w-full bg-transparent border-none p-4 pb-16 text-gray-700 outline-none resize-none" %>

          <div class="absolute bottom-3 left-3 flex items-center gap-1">
            <label class="p-2 text-gray-400 hover:text-indigo-600 cursor-pointer rounded-lg hover:bg-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.51a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
              <input type="file" class="hidden">
            </label>
            <button type="button" class="p-2 text-gray-400 hover:text-red-500 rounded-lg hover:bg-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>
          </div>

          <div class="absolute bottom-3 right-3">
            <%= f.submit "Send", class: "bg-indigo-600 text-white px-8 py-2.5 rounded-lg hover:bg-indigo-700 font-bold cursor-pointer" %>
          </div>
        </div>

        <% if @companies.present? %>
          <div class="flex flex-row items-center gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mr-2 whitespace-nowrap">Quick Filters:</span>

            <select id="cityFilter" onchange="filterCompanies()" class="bg-white border border-gray-200 text-gray-600 text-[11px] rounded-full px-4 py-1.5 outline-none cursor-pointer">
              <option value="">City</option>
              <% @companies.map(&:city).uniq.compact.sort.each do |city| %>
                <option value="<%= city %>"><%= city %></option>
              <% end %>
            </select>

            <select id="sectorFilter" onchange="filterCompanies()" class="bg-white border border-gray-200 text-gray-600 text-[11px] rounded-full px-4 py-1.5 outline-none cursor-pointer">
              <option value="">Sector</option>
              <% @companies.map(&:sector).uniq.compact.sort.each do |sector| %>
                <option value="<%= sector %>"><%= sector %></option>
              <% end %>
            </select>
          </div>
        <% end %>
      <% end %>

      <% if @companies.present? %>
        <% if @is_recommendation %>
          <div class="mb-6 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
            <p class="text-sm text-amber-800">
              ‚ö†Ô∏è I couldn't find exact matches for <strong>"<%= @message %>"</strong>, but these might interest you:
            </p>
          </div>
        <% end %>

        <div id="companiesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
          <% @companies.each do |company| %>
            <div class="company-card bg-gray-50 rounded-lg p-4 border border-gray-200 flex flex-col relative overflow-visible"
                 data-city="<%= company.city %>"
                 data-sector="<%= company.sector %>">

              <turbo-frame id="company_save_<%= company.id %>">
              <div class="absolute top-3 right-3 z-50">
                <button
                  id="listMenuBtn-<%= company.id %>"
                  type="button"
                  class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-gray-200 bg-white text-indigo-700 hover:bg-indigo-50 font-bold shadow-sm"
                  onclick="toggleListMenu('<%= company.id %>')"
                  title="Save to list">
                  +
                </button>
              </div>
              </turbo-frame>

              <div
                id="listMenu-<%= company.id %>"
                class="hidden fixed z-50 w-80 max-h-64 overflow-y-auto rounded-xl border border-gray-200 bg-white shadow-lg ring-1 ring-black/5"
              >
                <div class="py-2">
                  <% if @lists.present? %>
                    <p class="px-4 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                      Save to‚Ä¶
                    </p>

                    <% @lists.each do |list| %>
                      <%= button_to company_lists_path,
                          method: :post,
                          params: { list_id: list.id, company_list: { company_id: company.id } },
                          form: { data: { turbo_stream: true } },
                          class: "w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-start justify-between gap-3" do %>
                        <span class="whitespace-normal break-words pr-2 leading-snug"><%= list.name %></span>
                        <span class="text-xs text-gray-400">‚Üí</span>
                      <% end %>
                    <% end %>
                  <% else %>
                    <p class="px-4 py-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                      No lists yet
                    </p>
                  <% end %>

                  <div class="my-2 border-t border-gray-100"></div>

                  <%= link_to "+ Create a new list", lists_path,
                    class: "block px-4 py-2 text-sm font-semibold text-indigo-700 hover:bg-indigo-50" %>
                </div>
              </div>

              <strong class="text-lg text-indigo-900 mb-1"><%= company.company_name %></strong>
              <small class="text-gray-600 mb-2"><%= company.sector %> ¬∑ <%= company.city %></small>
              <p class="text-sm text-gray-700 mb-3 line-clamp-2"><%= company.description %></p>
              <small class="text-gray-500 mt-auto pt-2 border-t border-gray-100 flex justify-between">
                <span><%= company.employees %> employees</span>
                <span>Founded in <%= company.founded_year %></span>
              </small>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function filterCompanies() {
    const city = document.getElementById('cityFilter').value;
    const sector = document.getElementById('sectorFilter').value;
    const cards = document.querySelectorAll('.company-card');

    cards.forEach(card => {
      const matchCity = city === "" || card.getAttribute('data-city') === city;
      const matchSector = sector === "" || card.getAttribute('data-sector') === sector;

      if (matchCity && matchSector) {
        card.style.display = "flex";
      } else {
        card.style.display = "none";
      }
    });
  }

  function toggleListMenu(companyId) {
    // close other menus
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => {
      if (menu.id !== `listMenu-${companyId}`) menu.classList.add("hidden");
    });

    const menu = document.getElementById(`listMenu-${companyId}`);
    const btn  = document.getElementById(`listMenuBtn-${companyId}`);
    if (!menu || !btn) return;

    const isHidden = menu.classList.contains("hidden");
    if (!isHidden) {
      menu.classList.add("hidden");
      return;
    }

    menu.classList.remove("hidden");
    menu.style.visibility = "hidden";
    menu.style.left = "0px";
    menu.style.top = "0px";

    const btnRect = btn.getBoundingClientRect();
    const menuRect = menu.getBoundingClientRect();
    const gap = 8;

    let left = btnRect.right - menuRect.width;
    let top  = btnRect.bottom + gap;

    left = Math.max(8, Math.min(left, window.innerWidth - menuRect.width - 8));

    const spaceBelow = window.innerHeight - btnRect.bottom;
    if (spaceBelow < menuRect.height + gap) {
      top = btnRect.top - menuRect.height - gap;
      top = Math.max(8, top);
    }

    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.visibility = "visible";
  }

  document.addEventListener("click", (e) => {
    const isTrigger = e.target.closest("[id^='listMenuBtn-']");
    const isMenu = e.target.closest("[id^='listMenu-']");
    if (!isTrigger && !isMenu) {
      document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
    }
  });

  window.addEventListener("resize", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
  });

  document.addEventListener("turbo:submit-end", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu =>
    menu.classList.add("hidden")
    );
  });

  window.addEventListener("scroll", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
  }, { passive: true });
</script>
