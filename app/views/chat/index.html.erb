<div class="min-h-screen bg-[#fdf5e6] flex flex-col items-center py-10 px-4">
  <div class="max-w-4xl w-full">

    <div class="text-center mb-12">
      <p class="text-xl md:text-2xl text-black font-semibold flex items-center justify-center gap-2">
        üîç AI-Powered Discovery
      </p>
      <h1 class="text-5xl md:text-6xl font-bold text-black mt-4">
        Company Explorer
      </h1>
      <p class="mt-6 text-gray-600 text-lg md:text-xl max-w-3xl mx-auto leading-tight">
        <span class="block mb-2 text-black font-medium"> Ask our AI to find innovative companies. </span>
        <span class="text-gray-500 text-base md:text-lg">
          Use natural language to search by <span class="text-indigo-600">sector</span>, <span class="text-indigo-600">location</span>, and <span class="text-indigo-600">funding</span>.
        </span>
      </p>
    </div>

    <div class="w-full bg-white rounded-xl shadow-lg p-8 flex flex-col">
      <p class="text-gray-500 mb-4 text-lg">What would you like to know?</p>

      <%= form_with url: chat_path, method: :post, local: true, data: { turbo: false }, class: "w-full mb-6" do |f| %>
        <div class="relative border border-gray-300 rounded-xl focus-within:ring-2 focus-within:ring-indigo-500 bg-gray-50">
          <%= f.text_area :message, value: @message, placeholder: "Type your question here...",
              class: "w-full bg-transparent border-none p-4 pb-16 text-gray-700 outline-none resize-none" %>
          <div class="absolute bottom-3 right-3">
            <%= f.submit "Send", class: "bg-indigo-600 text-white px-8 py-2.5 rounded-lg hover:bg-indigo-700 font-bold cursor-pointer" %>
          </div>
        </div>

        <% if @companies.present? %>
          <div class="flex flex-row items-center gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mr-2 whitespace-nowrap">Quick Filters:</span>
            <select id="cityFilter" onchange="filterCompanies()" class="bg-white border border-gray-200 text-gray-600 text-[11px] rounded-full px-4 py-1.5 outline-none cursor-pointer">
              <option value="">City</option>
              <% @companies.map(&:city).uniq.compact.sort.each do |city| %>
                <option value="<%= city %>"><%= city %></option>
              <% end %>
            </select>
            <select id="sectorFilter" onchange="filterCompanies()" class="bg-white border border-gray-200 text-gray-600 text-[11px] rounded-full px-4 py-1.5 outline-none cursor-pointer">
              <option value="">Sector</option>
              <% @companies.map(&:sector).uniq.compact.sort.each do |sector| %>
                <option value="<%= sector %>"><%= sector %></option>
              <% end %>
            </select>
          </div>
        <% end %>
      <% end %>

      <% if @companies.present? %>
        <div id="companiesGrid" class="flex flex-col gap-6 mt-4 items-center w-full">
          <% @companies.each do |company| %>
            <div class="company-card relative w-full max-w-3xl bg-white rounded-xl border border-gray-200 shadow-sm p-6 flex flex-row justify-between cursor-pointer hover:border-indigo-300 transition-all"
                 data-city="<%= company.city %>"
                 data-sector="<%= company.sector %>"
                 onclick="document.getElementById('modal-<%= company.id %>').showModal()">

              <div class="absolute top-4 right-4 z-50">
                <%= button_to lists_path(company_name: company.company_name, sector: company.sector, city: company.city, description: company.description, employees: company.employees, founded_year: company.founded_year),
                    method: :post, class: "h-8 w-8 flex items-center justify-center rounded-full border border-gray-300 bg-white text-indigo-600 hover:bg-indigo-50 font-bold shadow-sm",
                    form: { data: { turbo: false } } do %>+<% end %>
              </div>

              <div class="flex flex-col gap-3 pr-12 w-2/3">
                <h2 class="text-xl font-bold text-gray-900 leading-tight truncate"><%= company.company_name %></h2>
                <p class="text-sm text-gray-600 line-clamp-2"><%= company.description %></p>
                <div class="flex flex-wrap gap-2">
                   <span class="px-2 py-0.5 text-[11px] bg-indigo-50 text-indigo-700 rounded-full font-medium"><%= company.sector %></span>
                   <span class="px-2 py-0.5 text-[11px] bg-gray-100 text-gray-600 rounded-full font-medium">B2B</span>
                </div>
                <div class="flex flex-col gap-1.5 mt-2">
                  <div class="flex items-center gap-2 text-sm text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400"><path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <%= company.city %>
                  </div>
                  <div class="flex items-center gap-2 text-sm text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"></path><path d="M5 21V7l7-4 7 4v14"></path></svg>
                    Founded <%= company.founded_year %>
                  </div>
                </div>
              </div>

              <div class="flex flex-col justify-center gap-4 pl-6 border-l border-gray-100 w-1/3">
                <div class="flex items-center gap-2 text-sm text-gray-700">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-indigo-500"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                  <span class="font-medium"><%= company.employees %> employees</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-700">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-500"><polyline points="3 17 9 11 13 15 21 7"></polyline><polyline points="14 7 21 7 21 14"></polyline></svg>
                  <span class="font-medium">‚Ç¨<%= number_to_human(company.revenue, units: { million: 'M' }) %> revenue</span>
                </div>
              </div>
            </div>

            <dialog id="modal-<%= company.id %>"
                    style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);"
                    class="z-50 m-0 w-[95%] max-w-2xl rounded-2xl border-none p-0 shadow-2xl backdrop:bg-black/60 backdrop:backdrop-blur-sm overflow-hidden">

              <div class="bg-white p-8 flex flex-col gap-6">

                <div class="flex justify-between items-start">
                  <div class="flex flex-col gap-1.5 w-2/3">
                    <div class="flex items-center gap-3">
                      <h2 class="text-xl font-bold text-gray-900 leading-tight truncate"><%= company.company_name %></h2>
                      <div class="px-3 py-1 rounded-full font-bold text-[10px] uppercase tracking-wider border shadow-sm"
                           style="background-color: #ecfdf5; color: #065f46; border-color: #d1fae5;">
                        ‚Ç¨<%= number_to_human(company.revenue, units: { million: 'M' }) %> REVENUE
                      </div>
                    </div>
                    <p class="text-[11px] text-gray-500 font-medium italic"><%= company.description.truncate(100) %></p>
                  </div>
                  <div class="flex items-center gap-3">
                    <button class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-bold hover:bg-indigo-700 transition-all">Save to list +</button>
                    <button onclick="document.getElementById('modal-<%= company.id %>').close()" class="text-gray-400 hover:text-gray-600 text-3xl font-light leading-none">&times;</button>
                  </div>
                </div>

                <div class="flex gap-2 -mt-4">
                  <span class="px-2 py-0.5 text-[10px] bg-indigo-50 text-indigo-700 rounded-full font-medium"><%= company.sector %></span>
                  <span class="px-2 py-0.5 text-[10px] bg-gray-100 text-gray-600 rounded-full font-medium">B2B</span>
                </div>

                <div>
                  <h3 class="text-[9px] font-bold uppercase tracking-widest text-gray-400 mb-2">Company Details</h3>
                  <div class="flex gap-3">
                    <div class="px-4 py-2 bg-gray-50 border border-gray-100 rounded-xl flex-1 flex flex-col justify-center shadow-sm">
                      <p class="text-[11px] font-bold text-gray-800 leading-tight"><%= company.owner rescue 'Jane Doe' %></p>
                      <p class="text-[9px] font-medium text-gray-400 uppercase tracking-tighter">Owner / CEO</p>
                    </div>
                    <div class="px-4 py-2 bg-gray-50 border border-gray-100 rounded-xl flex-1 flex flex-col justify-center shadow-sm">
                      <p class="text-[11px] font-bold text-gray-800 leading-tight"><%= company.employees %></p>
                      <p class="text-[9px] font-medium text-gray-400 uppercase tracking-tighter">Employees</p>
                    </div>
                    <div class="px-4 py-2 bg-gray-50 border border-gray-100 rounded-xl flex-1 flex flex-col justify-center shadow-sm">
                      <p class="text-[11px] font-bold text-gray-800 leading-tight"><%= company.founded_year %></p>
                      <p class="text-[9px] font-medium text-gray-400 uppercase tracking-tighter">Founded Year</p>
                    </div>
                  </div>
                </div>

                <div class="flex gap-8 pt-4 border-t border-gray-50 items-stretch">

                  <div class="w-40 h-36 bg-slate-50 border border-gray-300 rounded-2xl relative flex-shrink-0 flex flex-col items-center justify-center overflow-hidden">
                    <div class="absolute inset-0 opacity-20 bg-[linear-gradient(#cbd5e1_1px,transparent_1px),linear-gradient(90deg,#cbd5e1_1px,transparent_1px)] [background-size:18px_18px]"></div>

                    <div class="relative z-10 mb-2 flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ef4444" class="w-8 h-8 drop-shadow-lg">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                      </svg>
                    </div>

                    <div class="px-2 text-center relative z-10">
                      <p class="text-[9px] font-bold text-slate-800 uppercase tracking-tight"><%= company.city %></p>
                      <p class="text-[7px] text-slate-500 font-medium mt-0.5 leading-tight">
                        <%= company.address rescue "Main St. 123, Central District" %>
                      </p>
                    </div>
                  </div>

                  <div class="flex flex-col flex-1 gap-3">
                    <div class="p-4 border border-gray-300 rounded-xl bg-indigo-50/30 flex-1 flex flex-col justify-center">
                      <h4 class="text-[9px] font-bold uppercase tracking-widest text-indigo-400 mb-1.5 flex items-center gap-1">
                        <span class="h-1 w-1 bg-indigo-500 rounded-full"></span> AI Insight
                      </h4>
                      <p class="text-[11px] text-gray-700 leading-relaxed font-medium">
                        <%= company.company_name %> shows high potential in <%= company.sector %>. The current team structure supports expansion in <%= company.city %>, leverage their revenue of ‚Ç¨<%= number_to_human(company.revenue, units: { million: 'M' }) %> for growth.
                      </p>
                    </div>

                    <a href="https://<%= company.company_name.parameterize %>.com" target="_blank" class="flex items-center justify-between px-3 py-2 border border-gray-100 rounded-xl hover:bg-gray-100 transition-all bg-gray-50 group">
                      <div class="flex flex-col">
                        <span class="text-gray-600 text-[8px] font-bold truncate tracking-tight">
                          <%= company.company_name.parameterize %>.com
                        </span>
                        <span class="text-[7px] font-bold text-gray-500 uppercase tracking-tighter">view official website</span>
                      </div>
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-gray-400 group-hover:text-gray-600 transition-colors"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    </a>
                  </div>

                </div>
              </div>
            </dialog>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function filterCompanies() {
    const city = document.getElementById('cityFilter').value;
    const sector = document.getElementById('sectorFilter').value;
    document.querySelectorAll('.company-card').forEach(card => {
      const matchCity = city === "" || card.getAttribute('data-city') === city;
      const matchSector = sector === "" || card.getAttribute('data-sector') === sector;
      card.style.display = matchCity && matchSector ? "flex" : "none";
    });
  }

  function toggleListMenu(companyId) {
    // close other menus
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => {
      if (menu.id !== `listMenu-${companyId}`) menu.classList.add("hidden");
    });

    const menu = document.getElementById(`listMenu-${companyId}`);
    const btn  = document.getElementById(`listMenuBtn-${companyId}`);
    if (!menu || !btn) return;

    const isHidden = menu.classList.contains("hidden");
    if (!isHidden) {
      menu.classList.add("hidden");
      return;
    }

    menu.classList.remove("hidden");
    menu.style.visibility = "hidden";
    menu.style.left = "0px";
    menu.style.top = "0px";

    const btnRect = btn.getBoundingClientRect();
    const menuRect = menu.getBoundingClientRect();
    const gap = 8;

    let left = btnRect.right - menuRect.width;
    let top  = btnRect.bottom + gap;

    left = Math.max(8, Math.min(left, window.innerWidth - menuRect.width - 8));

    const spaceBelow = window.innerHeight - btnRect.bottom;
    if (spaceBelow < menuRect.height + gap) {
      top = btnRect.top - menuRect.height - gap;
      top = Math.max(8, top);
    }

    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.visibility = "visible";
  }

  document.addEventListener("click", (e) => {
    const isTrigger = e.target.closest("[id^='listMenuBtn-']");
    const isMenu = e.target.closest("[id^='listMenu-']");
    if (!isTrigger && !isMenu) {
      document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
    }
  });

  window.addEventListener("resize", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
  });

  document.addEventListener("turbo:submit-end", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu =>
    menu.classList.add("hidden")
    );
  });

  window.addEventListener("scroll", () => {
    document.querySelectorAll("[id^='listMenu-']").forEach(menu => menu.classList.add("hidden"));
  }, { passive: true });
</script>
